# trit_cpu_c++
Данный проект представляет собой реализацию процессора на троичной системе счисления (тритовый процессор) на языке C++. 
Процессор поддерживает базовые арифметические и логические операции, а также работу с памятью и регистрами.


## Триты, трайты, tword
Трит - это аналог бита в троичной системе счисления, которая может принимать три значения: -1, 0 и 1.
Внутри он реализован таким образом:
```cpp
enum class trit : int8_t {
    Minus = -1,
    Zero = 0,
    Plus = 1
};
```


Трайт - это группа из 3 тритов, которая представлять числа от -13 до 13 в троичной системе счисления.
Является машинным словом.
Используется для представления номеров регистров, числовых значений и опкодов инструкций.
Имеет следующую структуру:
```cpp
constexpr tryte(trit high, trit mid, trit low) noexcept {
        data = (encodetrit(high) << 4) | (encodetrit(mid) << 2) | encodetrit(low);
    }
```

Для вызова определенного трита из трайта используется метод `tryte.get(int index)`.

Для изменение определенного трита из трайта используется метод `tryte.set(int index, trit t)`.

Для вывода трайта в консоль используется метод `tryte.toString()`.

Примеры:
```cpp
tryte(trit::Zero, trit::Plus, trit::Plus); // представляет число 4 в троичной системе
tryte(trit::Minus, trit::Minus, trit::Zero); // представляет число -12 в троичной системе
registers[tryte(trit::Minus, trit::Minus, trit::Minus)]; // регистр с номером -13
```


tword - это группа из 2 трайтов: HI (старшие) и LO (младшие).
Используется для адресов памяти и числовых значений большего диапазона.
Из функционала поддерживает только inc и dec (увеличение и уменьшение на 1).
Имеет следующую структуру:
```cpp
tword(tryte hi = tryte(), tryte lo = tryte())
        : HI(hi), LO(lo) {
    }
```

Примеры:
```cpp
tword a = { tryte(trit::Plus, trit::Zero, trit::Zero), tryte(trit::Minus, trit::Plus, trit::Zero) }; // представляет число 237 в троичной системе
std::cout << a.HI.toString(); // вывод в консоль старших трайтов
std::cout << a.LO.toString(); // вывод в консоль младших трайтов
wreg[tryte(trit::Plus, trit::Plus, trit::Minus)] = { tryte(trit::Minus, trit::Zero, trit::Zero), tryte(trit::Zero, trit::Minus, trit::Plus) }; // запись в широкий регистр WR2 значения -245
pc{tryte(trit::Plus, trit::Plus, trit::Plus), tryte(trit::Plus, trit::Plus, trit::Plus)}; // адрес 364 в памяти
```


## Регистры и флаги

Основные регистры процессора это регистры общего назначения и широкие регистры.
Делят они один диапазон номеров от -13 до 13 (т.е. всего 27 регистров).
Регистры общего назначения (от -13 до 4, 18 регистров) хранят значения типа tryte, а широкие регистры (от 5 до 13, 9 регистров) хранят значения типа tword.
Для прощего запоминания номера широких регистров всегда начинаются с `tryte(trit::Plus, trit::X, trit::X)`, поэтому номера широких регистров образуют два последних трита.

Примеры:
```cpp
registers[tryte(trit::Zero, trit::Plus, trit::Minus)]; // регистр R2
registers[tryte(trit::Minus, trit::Minus, trit::Minus)]; // регистр R-13
wreg[tryte(trit::Plus, trit::Plus, trit::Minus)]; // широкий регистр WR2
```

Системные регистры pc (счетчик команд) и rsp (счетчик стека) также хранят значения типа tword.
Доступ к ним осуществляется через инструкции процессора.
rsp можно преобразовать в pc `operator pc() const { return pc(HI, LO); }`, но наоборот нельзя.

Существуют также флаги процессора: EX (флаг переполнения), LG (логический флаг) и SP (флаг стека).
Они хранятся состояние в виде тритов и могут принимать значения -1, 0 и 1.

EX используется в следующих инструкциях: INC, DEC, ADD, SUB, MOV.

LG используется в следующих инструкциях: CMP, JE, JNE.
+1 - истина, 0 - неопределено, -1 - ложь.

SP используется в следующих инструкциях: PUSH, POP, CALL, RET.
+1 - стек полный, 0 - стек не полный, -1 - стек пустой.


## Инструкции процессора

Процессор поддерживает следующий набор инструкций:

| №   | Инструкция | Назначение                           | Комментарий                         |
| --  | ---------- | ------------------------------------ | ----------------------------------- |
| 000 | NOP        | Пустая операция                      | В релизе исчезнит					|
| 00+ | HLT        | Остановка программы                  | В релизе изменит опкод на 000		|
| ??? | RESET      | Сброс процессора                     | В релизе изменит опкод на 00+		|
| +0+ | LOAD       | Загрузка значения в регистр          |                                     |
| +0- | STORE      | Запись значения регистра в память    |                                     |
| -0+ | LOADM      | Загрузка из памяти в регистр         | Возможно будет подрежимом LOAD      |
| -0- | STOREM     | Запись в память из регистра          | Возможно будет подрежимом STORE     |
| ++0 | INC        | Увеличение регистра на 1             |                                     |
| --0 | DEC        | Уменьшение регистра на 1             |                                     |
| 0++ | ADD        | Сложение                             |                                     |
| 0-- | SUB        | Вычитание                            |                                     |
| 0-+ | JMP        | Безусловный переход                  |                                     |
| +-+ | JE         | Переход если равно 0                 |                                     |
| --+ | JNE        | Переход если не равно 0              |                                     |
| 0-0 | CMP        | Сравнение                            |                                     |
| -++ | PUSH       | Поместить в стек                     |                                     |
| -+- | POP        | Извлечь из стека                     |                                     |
| +00 | CALL       | Вызов подпрограммы                   |                                     |
| -00 | RET        | Возврат из подпрограммы              |                                     |
| 0+0 | MOV        | Копировать значение между регистрами |                                     |
| -+0 | MUL        | Умножение                            |                                     |
| 0+- | DIV        | Деление                              |                                     |
| +-0 | AND        | Побитовое И                          | Пока не реализован на уровне опкода |
| +-- | OR         | Побитовое ИЛИ                        | Пока не реализован на уровне опкода |
| ++- | XOR        | Исключающее ИЛИ                      | Пока не реализован на уровне опкода |
| --- | NOT        | Побитовое отрицание                  |                                     |
| +++ | SHF        | Сдвиг трита                          |                                     |
| 00- | ASH        | Арифметический сдвиг трита           |                                     |

NOP - пустая операция, не выполняет никаких действий, временная инструкция для отладки.

HLT - останавливает выполнение процессора.

RESET - сбрасывает процессор в начальное состояние, очищая регистры и память.

LOAD - загружает значение из памяти в указанный регистр, прямой тип адресации. Имеет два операнда: номер регистра и адрес памяти.

STORE - сохраняет значение из указанного регистра в память, прямой тип адресации. Имеет два операнда: номер регистра и адрес памяти.

LOADM - загружает значение из памяти в указанный регистр, косвенный тип адресации. Имеет два операнда: номер регистра и номер регистра, где хранится адрес памяти.

STOREM - сохраняет значение из указанного регистра в память, косвенный тип адресации. Имеет два операнда: номер регистра и номер регистра, где хранится адрес памяти.

INC - увеличивает значение указанного регистра на 1. Имеет один операнд: номер регистра. Возвращает EX и новый трайт.

DEC - уменьшает значение указанного регистра на 1. Имеет один операнд: номер регистра. Возвращает EX и новый трайт.

ADD - складывает значения двух указанных регистров. Имеет два операнда: номер первого регистра и номер второго регистра. Возвращает EX и результат в первый регистр.

SUB - вычитает значение второго указанного регистра из первого. Имеет два операнда: номер первого регистра и номер второго регистра. Возвращает EX и результат в первый регистр.

В INC, DEC, ADD, SUB при переполнении EX устанавливается, но в регистр общего назначения не записывается. В регистре общего назначение остается значение.

JMP - выполняет безусловный переход к указанному адресу в памяти. Имеет один операнд: адрес памяти.

CMP - сравнивает значения двух указанных регистров. Имеет два операнда: номер первого регистра и номер второго регистра.
Устанавливает флаг LG в зависимости от результата сравнения.
LG = 1, если первый регистр больше второго. LG = 0, если равны. LG = -1, если первый регистр меньше второго.

JE - выполняет переход к указанному адресу в памяти, если флаг LG установлен в 0. Имеет один операнд: адрес памяти.

JNE - выполняет переход к указанному адресу в памяти, если флаг LG не равен 0. Имеет один операнд: адрес памяти.

PUSH - помещает значение указанного регистра в стек. Имеет один операнд: номер регистра. Обновляет флаг SP.

POP - извлекает значение из стека в указанный регистр. Имеет один операнд: номер регистра. Обновляет флаг SP.

Стек начинается с адреса +++ +++ и растет вниз к адресу +++ ---. Всего 27 ячеек памяти выделено под стек.
!!!Если код будет в адресах +++ ХХХ, то код программы может перезаписать стек!!!

CALL - сохраняет текущий адрес в памяти в стек и выполняет переход к указанному адресу в памяти. Имеет один операнд: адрес памяти. Обновляет флаг SP.

RET - извлекает адрес из стека и выполняет переход к этому адресу. Обновляет флаг SP.
!!!Во время выполнения CALL необходимо следить за состоянием стека, чтобы избежать потери адреса возвращения!!!

MOV - копирует значение в зависимости от режима. Первый операнд устанавливает режим копирования: +1 - копирует значение между регистрами, -1 - в общий регистр копируется значение, 0 - в широкий регистр копируется EX + общий регистр.
Тип операндов зависит от режима: для +1 - два операнда (номер первого общего регистра и номер второго общего регистра), для -1 - два операнд (номер общего регистра и значение), для 0 - два операнд (номер широкого регистра и номер общего регистра).

MUL - умножает значения двух указанных регистров. Имеет два операнда: номер первого регистра и номер второго регистра. Результат сохраняется в WR9 (+++).

DIV - делит значение первого указанного регистра на значение второго. Имеет два операнда: номер первого регистра и номер второго регистра. Результат сохраняется в WR9 (+++).
!!!Имеет не точность при делении. Работаю над этим!!!

AND, OR, XOR пока пишутся для CPU, но на уровне ALU они работают корректно.

NOT - выполняет побитовое отрицание значения указанного регистра. Имеет один операнд: номер регистра.

SHF - выполняет сдвиг трита значения указанного регистра влево или вправо. Имеет два операнда: номер регистра и направление сдвига (+1 - влево, -1 - вправо).

ASH - выполняет арифметический сдвиг трита значения указанного регистра влево или вправо. Имеет два операнда: номер регистра и направление сдвига (+1 - влево, -1 - вправо). 
Результат сохраняется в WR8 (++0).


## АЛУ и память

ALU выполняет все арифметические и логические операции процессора. Формально CPU сам ничего не считает, а только отдает данные в ALU и получает результат обратно.

Память процессора представлена регистром pc. Все команды должны иметь форму std::map<pc, cell>;, где cell - это вариативный контейнер, который может хранить трит, трайт и адрес памяти (pc).
Из за того, что pc состоит из двух трайтов, максимальный размер памяти процессора составляет 729 ячеек памяти (от -364 до 364).

Вскором времени перепишу saveToFile и loadFromFile для текущей работы с памятью процессора, чтобы можно было сохранять и загружать программы из файлов.


## Прочиее

Файл trit6.h пока не интегрирован в процессор, но в будущем планируется использовать его для системы ввода/вывода.

utils.h - костыль, содержит вспомогательные функции для конвертации между десятичной и троичной системами счисления. Нужен только для регистров, хотя может в скором времени пропасть.

## Запуск и использование

Для запуска процессора в main необходимо инициолизировать процессор
```cpp
Memory mem; // Инициализация памяти
Registers registers; // Инициализация регистров
CPU cpu(registers); // Инициализация процессора с регистрами
cpu.attachmemory(&mem); // Привязка памяти к процессору
Wide_Reg wreg; // Инициализация широких регистров
```

Далее пишем необходимые команды для программы в следующем формате `mem.set(pc{ tryte(trit::Minus, trit::Minus, trit::Minus), tryte(trit::Minus, trit::Minus, trit::Zero) }, tryte(trit::Zero, trit::Plus, trit::Zero));`.

mem.set - метод для записи в память

pc{ tryte(trit::Minus, trit::Minus, trit::Minus), tryte(trit::Minus, trit::Minus, trit::Zero) } - адрес памяти

tryte(trit::Zero, trit::Plus, trit::Zero) - опкод или значение

В конце не обязательно должен быть tryte, можно использовать любое значение из cell. 

После написания программы вызываем метод cpu.run(); для запуска процессора.


!!!ВАЖНО!!!

Считать номера адресов памяти, если не понимаете как перевести из десятичной системы в троичную, можно использовать сайт https://www.trinary.su/projects/translator/

## License / Лицензия
This project is licensed under the MIT License — see the [LICENSE](LICENSE) file for details.  
Этот проект распространяется по лицензии MIT — см. файл [LICENSE](LICENSE) для подробностей.
